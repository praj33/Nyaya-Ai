#!/usr/bin/env python3
"""
Enhanced Legal Query Analyzer
Uses comprehensive database (1,693 sections + procedures) for accurate legal analysis
"""
import json
import os
from typing import Dict, List, Any

class EnhancedLegalQueryAnalyzer:
    def __init__(self):
        self.main_db = {}
        self.procedure_db = {}
        self.load_databases()
        
    def load_databases(self):
        """Load both main database and procedure datasets"""
        # Load main database (1,693 sections)
        db_path = "db"
        for filename in os.listdir(db_path):
            if filename.endswith('.json'):
                filepath = os.path.join(db_path, filename)
                try:
                    with open(filepath, 'r', encoding='utf-8') as f:
                        self.main_db[filename] = json.load(f)
                except Exception as e:
                    continue
        
        # Load procedure datasets
        proc_path = "../nyaya-legal-procedure-datasets/data/procedures"
        if os.path.exists(proc_path):
            for jurisdiction in ['india', 'uk', 'uae', 'ksa']:
                jurisdiction_path = os.path.join(proc_path, jurisdiction)
                if os.path.exists(jurisdiction_path):
                    self.procedure_db[jurisdiction] = {}
                    for domain_file in os.listdir(jurisdiction_path):
                        if domain_file.endswith('.json'):
                            domain = domain_file.replace('.json', '')
                            filepath = os.path.join(jurisdiction_path, domain_file)
                            try:
                                with open(filepath, 'r', encoding='utf-8') as f:
                                    self.procedure_db[jurisdiction][domain] = json.load(f)
                            except Exception as e:
                                continue
    
    def analyze_legal_query(self, query: str) -> Dict[str, Any]:
        """Comprehensive legal query analysis"""
        # Search main database for relevant sections
        main_results = self.search_legal_sections(query)
        
        # Search procedure database
        procedure_results = self.search_procedures(query)
        
        # Generate comprehensive analysis
        analysis = {
            "query": query,
            "legal_sections": main_results,
            "procedures": procedure_results,
            "analysis": self.generate_legal_analysis(query, main_results, procedure_results),
            "recommendations": self.generate_recommendations(query, main_results, procedure_results)
        }
        
        return analysis
    
    def search_legal_sections(self, query: str) -> Dict[str, Any]:
        """Search 1,693 legal sections for relevant matches"""
        results = {
            "total_sections": 0,
            "relevant_sections": [],
            "by_act": {},
            "by_jurisdiction": {}
        }
        
        query_lower = query.lower()
        keywords = set(word.lower() for word in query.split() if len(word) > 2)
        
        # Crime-specific mappings for better accuracy
        crime_mappings = {
            'rape': ['63', '64', '65', '66', '375', '376'],
            'murder': ['100', '101', '103', '299', '300', '302'],
            'theft': ['303', '304', '378', '379', '380'],
            'dowry': ['80', '304B', '498A'],
            'divorce': ['13', '82', '83'],
            'harassment': ['75', '354A', '509']
        }
        
        # Direct crime mapping
        for crime, sections in crime_mappings.items():
            if crime in query_lower:
                results["relevant_sections"].extend(self.find_sections_by_numbers(sections, crime))\n        \n        # Keyword-based search through all files\n        for filename, data in self.main_db.items():\n            file_sections = self.extract_sections_from_file(filename, data, keywords, query_lower)\n            results[\"relevant_sections\"].extend(file_sections)\n        \n        # Remove duplicates and organize\n        unique_sections = {}\n        for section in results[\"relevant_sections\"]:\n            key = f\"{section['act']}_{section['section_number']}\"\n            if key not in unique_sections:\n                unique_sections[key] = section\n        \n        results[\"relevant_sections\"] = list(unique_sections.values())\n        results[\"total_sections\"] = len(results[\"relevant_sections\"])\n        \n        # Organize by act and jurisdiction\n        for section in results[\"relevant_sections\"]:\n            act = section[\"act\"]\n            jurisdiction = section.get(\"jurisdiction\", \"India\")\n            \n            if act not in results[\"by_act\"]:\n                results[\"by_act\"][act] = []\n            results[\"by_act\"][act].append(section)\n            \n            if jurisdiction not in results[\"by_jurisdiction\"]:\n                results[\"by_jurisdiction\"][jurisdiction] = []\n            results[\"by_jurisdiction\"][jurisdiction].append(section)\n        \n        return results\n    \n    def find_sections_by_numbers(self, section_numbers: List[str], crime_type: str) -> List[Dict]:\n        \"\"\"Find specific sections by their numbers\"\"\"\n        found_sections = []\n        \n        for filename, data in self.main_db.items():\n            if isinstance(data, dict):\n                # Search in IPC structure\n                if \"key_sections\" in data:\n                    for category, sections in data[\"key_sections\"].items():\n                        if isinstance(sections, dict):\n                            for num, text in sections.items():\n                                if num in section_numbers:\n                                    found_sections.append({\n                                        \"section_number\": num,\n                                        \"text\": text,\n                                        \"act\": \"IPC\",\n                                        \"category\": category,\n                                        \"jurisdiction\": \"India\",\n                                        \"relevance\": \"Direct match\",\n                                        \"crime_type\": crime_type\n                                    })\n                \n                # Search in BNS structure\n                elif \"structure\" in data:\n                    for category, sections in data[\"structure\"].items():\n                        if isinstance(sections, dict):\n                            for num, text in sections.items():\n                                if num in section_numbers:\n                                    found_sections.append({\n                                        \"section_number\": num,\n                                        \"text\": text,\n                                        \"act\": \"BNS\",\n                                        \"category\": category,\n                                        \"jurisdiction\": \"India\",\n                                        \"relevance\": \"Direct match\",\n                                        \"crime_type\": crime_type\n                                    })\n        \n        return found_sections\n    \n    def extract_sections_from_file(self, filename: str, data: Any, keywords: set, query_lower: str) -> List[Dict]:\n        \"\"\"Extract relevant sections from a file\"\"\"\n        sections = []\n        \n        if isinstance(data, dict):\n            if \"key_sections\" in data:  # IPC\n                for category, category_sections in data[\"key_sections\"].items():\n                    if isinstance(category_sections, dict):\n                        for num, text in category_sections.items():\n                            if isinstance(text, str) and self.is_section_relevant(text, keywords, query_lower):\n                                sections.append({\n                                    \"section_number\": num,\n                                    \"text\": text,\n                                    \"act\": \"IPC\",\n                                    \"category\": category,\n                                    \"jurisdiction\": \"India\",\n                                    \"file\": filename\n                                })\n            \n            elif \"structure\" in data:  # BNS\n                for category, category_sections in data[\"structure\"].items():\n                    if isinstance(category_sections, dict):\n                        for num, text in category_sections.items():\n                            if isinstance(text, str) and self.is_section_relevant(text, keywords, query_lower):\n                                sections.append({\n                                    \"section_number\": num,\n                                    \"text\": text,\n                                    \"act\": \"BNS\",\n                                    \"category\": category,\n                                    \"jurisdiction\": \"India\",\n                                    \"file\": filename\n                                })\n        \n        return sections\n    \n    def is_section_relevant(self, text: str, keywords: set, query_lower: str) -> bool:\n        \"\"\"Check if a section is relevant to the query\"\"\"\n        text_lower = text.lower()\n        \n        # High-priority terms\n        priority_terms = ['rape', 'murder', 'theft', 'assault', 'dowry', 'divorce', 'harassment']\n        for term in priority_terms:\n            if term in query_lower and term in text_lower:\n                return True\n        \n        # Keyword matching\n        matches = sum(1 for keyword in keywords if keyword in text_lower)\n        return matches >= 2\n    \n    def search_procedures(self, query: str) -> Dict[str, Any]:\n        \"\"\"Search procedure datasets\"\"\"\n        results = {\n            \"total_procedures\": 0,\n            \"relevant_procedures\": [],\n            \"by_jurisdiction\": {}\n        }\n        \n        query_lower = query.lower()\n        \n        for jurisdiction, domains in self.procedure_db.items():\n            for domain, procedure_data in domains.items():\n                if self.is_procedure_relevant(procedure_data, query_lower, domain):\n                    proc_info = self.extract_procedure_info(procedure_data, jurisdiction, domain)\n                    results[\"relevant_procedures\"].append(proc_info)\n                    \n                    if jurisdiction not in results[\"by_jurisdiction\"]:\n                        results[\"by_jurisdiction\"][jurisdiction] = []\n                    results[\"by_jurisdiction\"][jurisdiction].append(proc_info)\n        \n        results[\"total_procedures\"] = len(results[\"relevant_procedures\"])\n        return results\n    \n    def is_procedure_relevant(self, procedure_data: Dict, query_lower: str, domain: str) -> bool:\n        \"\"\"Check if a procedure is relevant\"\"\"\n        # Domain match\n        if domain.lower() in query_lower:\n            return True\n        \n        # Check procedure steps\n        if \"procedure\" in procedure_data and \"steps\" in procedure_data[\"procedure\"]:\n            for step in procedure_data[\"procedure\"][\"steps\"]:\n                step_text = f\"{step.get('title', '')} {step.get('description', '')}\".lower()\n                if any(word in step_text for word in query_lower.split() if len(word) > 3):\n                    return True\n        \n        return False\n    \n    def extract_procedure_info(self, procedure_data: Dict, jurisdiction: str, domain: str) -> Dict:\n        \"\"\"Extract procedure information\"\"\"\n        proc = procedure_data.get(\"procedure\", {})\n        return {\n            \"jurisdiction\": jurisdiction.title(),\n            \"domain\": domain.title(),\n            \"steps\": len(proc.get(\"steps\", [])),\n            \"timelines\": proc.get(\"timelines\", {}),\n            \"documents\": proc.get(\"documents_required\", []),\n            \"authorities\": proc.get(\"authority\", []),\n            \"key_steps\": [step.get(\"title\", \"\") for step in proc.get(\"steps\", [])[:5]]\n        }\n    \n    def generate_legal_analysis(self, query: str, main_results: Dict, procedure_results: Dict) -> Dict[str, Any]:\n        \"\"\"Generate comprehensive legal analysis\"\"\"\n        return {\n            \"query_type\": self.classify_query_type(query),\n            \"primary_jurisdiction\": self.determine_jurisdiction(main_results, procedure_results),\n            \"legal_domain\": self.determine_domain(query, main_results),\n            \"confidence_score\": self.calculate_confidence(main_results, procedure_results),\n            \"complexity\": self.assess_complexity(main_results, procedure_results),\n            \"key_findings\": self.extract_key_findings(main_results, procedure_results)\n        }\n    \n    def classify_query_type(self, query: str) -> str:\n        \"\"\"Classify the type of legal query\"\"\"\n        query_lower = query.lower()\n        \n        if any(word in query_lower for word in ['punishment', 'penalty', 'sentence']):\n            return \"Penalty Inquiry\"\n        elif any(word in query_lower for word in ['procedure', 'process', 'file', 'steps']):\n            return \"Procedural Inquiry\"\n        elif any(word in query_lower for word in ['rights', 'remedies', 'compensation']):\n            return \"Rights & Remedies\"\n        else:\n            return \"General Legal Query\"\n    \n    def determine_jurisdiction(self, main_results: Dict, procedure_results: Dict) -> str:\n        \"\"\"Determine primary jurisdiction\"\"\"\n        # Count sections by jurisdiction\n        jurisdiction_scores = {}\n        \n        for jurisdiction, sections in main_results[\"by_jurisdiction\"].items():\n            jurisdiction_scores[jurisdiction] = len(sections)\n        \n        for jurisdiction, procedures in procedure_results[\"by_jurisdiction\"].items():\n            jurisdiction_scores[jurisdiction.title()] = jurisdiction_scores.get(jurisdiction.title(), 0) + len(procedures) * 2\n        \n        return max(jurisdiction_scores, key=jurisdiction_scores.get) if jurisdiction_scores else \"India\"\n    \n    def determine_domain(self, query: str, main_results: Dict) -> str:\n        \"\"\"Determine legal domain\"\"\"\n        query_lower = query.lower()\n        \n        if any(word in query_lower for word in ['rape', 'murder', 'theft', 'assault', 'criminal']):\n            return \"Criminal Law\"\n        elif any(word in query_lower for word in ['divorce', 'marriage', 'family', 'custody']):\n            return \"Family Law\"\n        elif any(word in query_lower for word in ['contract', 'property', 'civil', 'tort']):\n            return \"Civil Law\"\n        else:\n            return \"General Law\"\n    \n    def calculate_confidence(self, main_results: Dict, procedure_results: Dict) -> float:\n        \"\"\"Calculate confidence score\"\"\"\n        base_score = 0.1\n        \n        # Main database contribution\n        sections_found = main_results[\"total_sections\"]\n        if sections_found > 0:\n            base_score += min(0.6, sections_found * 0.03)\n        \n        # Procedure contribution\n        procedures_found = procedure_results[\"total_procedures\"]\n        if procedures_found > 0:\n            base_score += min(0.3, procedures_found * 0.1)\n        \n        return min(0.95, base_score)\n    \n    def assess_complexity(self, main_results: Dict, procedure_results: Dict) -> str:\n        \"\"\"Assess case complexity\"\"\"\n        total_elements = main_results[\"total_sections\"] + procedure_results[\"total_procedures\"]\n        \n        if total_elements >= 20:\n            return \"High\"\n        elif total_elements >= 10:\n            return \"Medium\"\n        else:\n            return \"Low\"\n    \n    def extract_key_findings(self, main_results: Dict, procedure_results: Dict) -> List[str]:\n        \"\"\"Extract key findings\"\"\"\n        findings = []\n        \n        if main_results[\"total_sections\"] > 0:\n            findings.append(f\"Found {main_results['total_sections']} relevant legal sections\")\n            \n            # Top acts\n            top_acts = sorted(main_results[\"by_act\"].items(), key=lambda x: len(x[1]), reverse=True)[:3]\n            for act, sections in top_acts:\n                findings.append(f\"{act}: {len(sections)} sections\")\n        \n        if procedure_results[\"total_procedures\"] > 0:\n            findings.append(f\"Found {procedure_results['total_procedures']} relevant procedures\")\n        \n        return findings\n    \n    def generate_recommendations(self, query: str, main_results: Dict, procedure_results: Dict) -> List[str]:\n        \"\"\"Generate actionable recommendations\"\"\"\n        recommendations = []\n        \n        if main_results[\"total_sections\"] > 0:\n            recommendations.append(\"Review the relevant legal sections for specific provisions\")\n            \n            # Check for criminal matters\n            criminal_sections = [s for s in main_results[\"relevant_sections\"] if 'punishment' in s.get('text', '').lower()]\n            if criminal_sections:\n                recommendations.append(\"Consider immediate legal consultation for criminal matters\")\n        \n        if procedure_results[\"total_procedures\"] > 0:\n            recommendations.append(\"Follow the procedural steps outlined for your jurisdiction\")\n            recommendations.append(\"Prepare required documents as specified in procedures\")\n        \n        if not main_results[\"total_sections\"] and not procedure_results[\"total_procedures\"]:\n            recommendations.append(\"Consult with a legal professional for specialized advice\")\n            recommendations.append(\"Consider refining your query with more specific legal terms\")\n        \n        return recommendations

def demonstrate_enhanced_analyzer():
    \"\"\"Demonstrate the enhanced analyzer capabilities\"\"\"\n    analyzer = EnhancedLegalQueryAnalyzer()\n    \n    test_queries = [\n        \"What is the punishment for rape in India?\",\n        \"How to file for divorce in India?\",\n        \"Dowry harassment case procedures and penalties\"\n    ]\n    \n    print(\"ENHANCED LEGAL QUERY ANALYZER\")\n    print(\"=\" * 60)\n    print(f\"Database: 1,693+ legal sections + procedures\")\n    print(f\"Jurisdictions: India, UK, UAE, KSA\")\n    print(\"=\" * 60)\n    \n    for i, query in enumerate(test_queries, 1):\n        print(f\"\\n{i}. QUERY: {query}\")\n        print(\"-\" * 50)\n        \n        result = analyzer.analyze_legal_query(query)\n        \n        # Analysis summary\n        analysis = result[\"analysis\"]\n        print(f\"Type: {analysis['query_type']}\")\n        print(f\"Domain: {analysis['legal_domain']}\")\n        print(f\"Jurisdiction: {analysis['primary_jurisdiction']}\")\n        print(f\"Confidence: {analysis['confidence_score']:.2f}\")\n        print(f\"Complexity: {analysis['complexity']}\")\n        \n        # Results summary\n        sections = result[\"legal_sections\"]\n        procedures = result[\"procedures\"]\n        print(f\"\\nResults:\")\n        print(f\"  Legal Sections: {sections['total_sections']}\")\n        print(f\"  Procedures: {procedures['total_procedures']}\")\n        \n        # Key findings\n        if analysis[\"key_findings\"]:\n            print(f\"\\nKey Findings:\")\n            for finding in analysis[\"key_findings\"]:\n                print(f\"  • {finding}\")\n        \n        # Top sections\n        if sections[\"relevant_sections\"]:\n            print(f\"\\nTop Relevant Sections:\")\n            for section in sections[\"relevant_sections\"][:3]:\n                print(f\"  • Section {section['section_number']} ({section['act']}): {section['text'][:80]}...\")\n        \n        # Recommendations\n        if result[\"recommendations\"]:\n            print(f\"\\nRecommendations:\")\n            for rec in result[\"recommendations\"]:\n                print(f\"  • {rec}\")\n\nif __name__ == \"__main__\":\n    demonstrate_enhanced_analyzer()